---
title: "R Notebook"
output: html_notebook
---

Here we repeat the linear modeling to detect changes in RNA binding but only use the OOPS data, e.g only look for changes in the protein abundance in the OOPS TMT and ignore the total TMT (for now; we can always return to the total TMT later).
```{r}
source("../../CamProt_R/Utility.R")

library(tidyverse)
```

```{r}
total_protein_quant <- readRDS("../results/total_res_pro_agg_norm")
oops_protein_quant <- readRDS("../results/rbp_res_pro_agg_norm")
```


```{r}
intersecting_proteins <- intersect(rownames(total_protein_quant), rownames(oops_protein_quant))
print(length(intersecting_proteins))
```

```{r}
makeLongExprs <- function(obj){
  
  obj_exprs <- exprs(obj[intersecting_proteins,])
  colnames(obj_exprs) <- pData(obj)$Sample_name
  
  long_exprs <- obj_exprs %>%
    data.frame() %>%
    tibble::rownames_to_column("UniprotID") %>%
    gather(key="Sample", value="Intensity", -UniprotID) %>%
    separate(Sample, into=c("Condition", "Replicate"))
  
  return(long_exprs)
}

protein_info <- read.delim("../shared_files/human_protein_ids_plus_gene_names.tsv")


total_exprs <- makeLongExprs(total_protein_quant)
total_exprs$Condition <- factor(total_exprs$Condition, levels=c("Untreated", "Starved", "Insulin"))
total_exprs <- total_exprs %>% merge(protein_info, by.x="UniprotID", by.y="Entry")

oops_exprs <- makeLongExprs(oops_protein_quant)
oops_exprs$Condition <- factor(oops_exprs$Condition, levels=c("Untreated", "Starved", "Insulin"))
oops_exprs <- oops_exprs %>% merge(protein_info, by.x="UniprotID", by.y="Entry")

print(table(oops_exprs$Condition))
print(table(total_exprs$Condition))
```

```{r}
testModels <- function(obj, coeff_of_interest="ConditionInsulin"){
  fit1 <- obj %>% lm(formula=Intensity~Condition+Replicate)
  
  fit2 <- obj %>% lm(formula=Intensity~Condition)
  
  if ( AIC(fit1) < AIC(fit2) ) {
    chosen_fit <- fit1
    fit_name <- "With_replicate"

  } else {
    chosen_fit <- fit2
    fit_name <- "Without_replicate"
  }

  fit_values <- c(coef(summary(chosen_fit))[coeff_of_interest,],
                  summary(chosen_fit)$adj.r.squared,
                  fit_name)
  
  names(fit_values)[4:6] <- c("p_value", "adj_R_squared", "fit")
  
  return(fit_values)
}


fit_values <- oops_exprs %>%
  filter(Entry.name == 'UBA6_HUMAN', Condition %in% c("Untreated", "Insulin")) %>%
  testModels()

print(fit_values)

```
```{r}
runLM <- function(obj, coeff_of_interest="ConditionInsulin"){
   results <- obj %>%
    plyr::ddply("UniprotID", function(x) testModels(x, coeff_of_interest))
  
  for(column in c("Estimate", "Std. Error", "t value", "adj_R_squared", "p_value")){
    results[[column]] <- as.numeric(results[[column]])
    }
   
  results$BH <- p.adjust(results$p_value, method="BH")
  
  # Merge in the protein names etc
  results <- results %>% merge(protein_info, by.x="UniprotID", by.y="Entry")
  
  return(results)
   
}

Untreated_vs_Insulin <- oops_exprs %>% filter(Condition %in% c("Untreated", "Insulin")) %>%
  runLM("ConditionInsulin")

```

```{r}
plotP <- function(obj){
  p <- ggplot(obj, aes(p_value)) + geom_histogram(bins=40) + my_theme
  print(p)
}

plotP(Untreated_vs_Insulin)
```

```{r}
summariseSignificantChanges <- function(obj){
  cat("Which fit was best?")
  print(table(obj$fit))
  
  cat("\nHow many p-values < 0.01 per fit 'type'?")
  print(table(obj$fit, obj$p_value<0.01))
  
  cat("\nHow many significant changes in RNA binding (1% FDR)?")
  print(table(ifelse(obj$BH<0.01, "Sig.", "Not Sig."), ifelse(obj$Estimate>0, "Up", "Down")))
  
  cat("\nHow many significant changes in RNA binding (10% FDR)?")
  print(table(ifelse(obj$BH<0.1, "Sig.", "Not Sig."), ifelse(obj$Estimate>0, "Up", "Down")))

}

summariseSignificantChanges(Untreated_vs_Insulin)

```
So no significant changes for Untreated vs Insulin



Next, we test starved vs insulin
```{r}
Starved_vs_Insulin <- oops_exprs %>% filter(Condition %in% c("Starved", "Insulin")) %>%
  runLM("ConditionInsulin")

plotP(Starved_vs_Insulin)
summariseSignificantChanges(Starved_vs_Insulin)
```


Again, no signficant differences are detected. For Untreated vs starved (below), there is a single protein which is significant at 10%FDR. This is [Q9BQG0 (MBB1A_HUMAN)](https://www.uniprot.org/uniprot/Q9BQG0). 
```{r}
Untreated_vs_Starved <- oops_exprs %>% filter(Condition %in% c("Untreated", "Starved")) %>%
  runLM("ConditionStarved")

plotP(Untreated_vs_Starved)
summariseSignificantChanges(Untreated_vs_Starved)

Untreated_vs_Starved %>% arrange(p_value) %>% head()
```

Let's check the data for Q9BQG0.
```{r}
total_exprs$Type <- "Total"
oops_exprs$Type <- "OOPS"
combined_exprs <- rbind(total_exprs, oops_exprs)
combined_exprs$Type <- factor(combined_exprs$Type, levels=c("Total", "OOPS"))
p <- combined_exprs %>% filter(UniprotID=="Q9BQG0") %>%
  ggplot(aes(Condition, Intensity, colour=Replicate, group=Replicate)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Type,  ncol=2) +
  my_theme
  
print(p)
```

OK, so it does indeed seem to have lower RNA binding in Starved vs Untreated but it's a relatively small change (0.82-fold change) and the Total and OOPS (Insulin) are much more noisy. Suggests this is likely to a fluke one-off from running 1354 tests * 3 pairwise comparisons * 2 approaches (1.model all together; 2.model just OOPS)



