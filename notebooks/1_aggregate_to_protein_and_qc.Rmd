---
title: "QC and Aggregation to protein-level quantification"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Here we take the peptide-level quantification from PD and perform some QC before aggregating to protein-level quantification

```{r, echo=FALSE}
#suppressMessages(library(MSnbase))
#suppressMessages(library(dplyr))

#source("../../CamProt_R/OOPS_analysis.R", chdir=TRUE)
source("../../CamProt_R/Utility.R", chdir=TRUE)

```

```{r}
glycoproteins <- read.table("../shared_files/glycoproteins.tsv", sep="\t", header=TRUE)
glycoproteins <- glycoproteins %>% pull(protein) %>% as.character() %>% unique()
```

Read in the raw data
## 1. Total Non-Stimulated vs Stimulated
```{r, echo=FALSE}
total_peptides_us_df <- parse_features("../raw/Vero_N_I_Total_PeptideGroups_reannot.txt",
                                    master_protein_col='Master.Protein.Accessions',
                                    protein_col='Master.Protein.Accessions')

# remove glycoproteins
total_peptides_us_noglyc_df <- total_peptides_us_df[!total_peptides_us_df$Master.Protein.Accessions %in% glycoproteins,]
cat(sprintf("%s\tExcluding glycoproteins\n", length(rownames(total_peptides_us_noglyc_df))))
cat(sprintf("\nThese peptides are associated with %s master proteins\n", 
            length(unique(total_peptides_us_noglyc_df$Master.Protein.Accessions))))
```
## 2. RBP Non-Stimulated vs Stimulated
```{r, echo=FALSE}
rbp_peptides_us_df <- parse_features("../raw/Vero_N_I_RBP_PeptideGroups_reannot.txt",
                                  master_protein_col='Master.Protein.Accessions',
                                  protein_col='Master.Protein.Accessions')

# remove glycoproteins
rbp_peptides_us_noglyc_df <- rbp_peptides_us_df[!rbp_peptides_us_df$Master.Protein.Accessions %in% glycoproteins,]
cat(sprintf("%s\tExcluding glycoproteins\n", length(rownames(rbp_peptides_us_noglyc_df))))
cat(sprintf("\nThese peptides are associated with %s master proteins\n", 
            length(unique(rbp_peptides_us_noglyc_df$Master.Protein.Accessions))))

```
## 3. Total Unstarved vs Starved
```{r, echo=FALSE}
total_peptides_us_df <- parse_features("../raw/Vero_U_S_Total_PeptideGroups_reannot.txt",
                                    master_protein_col='Master.Protein.Accessions',
                                    protein_col='Master.Protein.Accessions')

# remove glycoproteins
total_peptides_us_noglyc_df <- total_peptides_us_df[!total_peptides_us_df$Master.Protein.Accessions %in% glycoproteins,]
cat(sprintf("%s\tExcluding glycoproteins\n", length(rownames(total_peptides_us_noglyc_df))))
cat(sprintf("\nThese peptides are associated with %s master proteins\n", 
            length(unique(total_peptides_us_noglyc_df$Master.Protein.Accessions))))
```
## 4. RBP Unstarved vs Starved
```{r, echo=FALSE}
rbp_peptides_us_df <- parse_features("../raw/Vero_U_S_RBP_PeptideGroups_reannot.txt",
                                  master_protein_col='Master.Protein.Accessions',
                                  protein_col='Master.Protein.Accessions')

# remove glycoproteins
rbp_peptides_us_noglyc_df <- rbp_peptides_us_df[!rbp_peptides_us_df$Master.Protein.Accessions %in% glycoproteins,]
cat(sprintf("%s\tExcluding glycoproteins\n", length(rownames(rbp_peptides_us_noglyc_df))))
cat(sprintf("\nThese peptides are associated with %s master proteins\n", 
            length(unique(rbp_peptides_us_noglyc_df$Master.Protein.Accessions))))

```
Summarise the numbber of RBPs and Total proteins in each set of experiments
## 1. Non-Stimulated vs Stimulated
```{r}

cat(sprintf("\n # RBP master proteins also in total: %s\n",
            length(intersect(unique(total_peptides_us_df$Master.Protein.Accessions),
                             unique(rbp_peptides_us_df$Master.Protein.Accessions)))))
cat(sprintf("\n # RBP master proteins NOT in total: %s \n",
            length(setdiff(unique(rbp_peptides_us_df$Master.Protein.Accessions),
                           unique(total_peptides_us_df$Master.Protein.Accessions)))))

cat(sprintf("\n Percentage RBP master proteins in total: %s \n",round(print(length(intersect(unique(total_peptides_us_df$Master.Protein.Accessions),
                       unique(rbp_peptides_us_df$Master.Protein.Accessions)))*100/
        length(unique(rbp_peptides_us_df$Master.Protein.Accessions))),2)))

```
## 2. Unstarved vs Starved
```{r}

cat(sprintf("\n # RBP master proteins also in total: %s\n",
            length(intersect(unique(total_peptides_us_df$Master.Protein.Accessions),
                             unique(rbp_peptides_us_df$Master.Protein.Accessions)))))
cat(sprintf("\n # RBP master proteins NOT in total: %s \n",
            length(setdiff(unique(rbp_peptides_us_df$Master.Protein.Accessions),
                           unique(total_peptides_us_df$Master.Protein.Accessions)))))

cat(sprintf("\n Percentage RBP master proteins in total: %s \n",round(print(length(intersect(unique(total_peptides_us_df$Master.Protein.Accessions),
                       unique(rbp_peptides_us_df$Master.Protein.Accessions)))*100/
        length(unique(rbp_peptides_us_df$Master.Protein.Accessions))),2)))

```
In the Non-Stimulated vs Insulin Stimulated experiments, nearly 80% of RBPs are also in the total samples. In the Unstarved vs Starved experiments, only about 70% of RBPs are also in the total samples. 

For most of the RBPs we will also have information regarding the changes in the total abundance for the protein, regardless of the abundance of the RNA-bound fraction. However, for 20-30% of them, we won't. 

Let's start aggregating the quantification.

First we create the dataframes to make an MSnSet object...
```{r}
summariseMissing <- function(res){
cat("\ntallies for missing data (# samples with missing)")
print(table(rowSums(is.na(as.data.frame(exprs(res))))))
}

samples_ni_inf <- "../raw/samples_N_I.tsv"
samples_us_inf <- "../raw/samples_U_S.tsv"

total_ni_res <- makeMSNSet(total_peptides_ni_df, samples_ni_inf)
rbp_ni_res <- makeMSNSet(rbp_peptides_ni_df, samples_ni_inf)

total_us_res <- makeMSNSet(total_peptides_us_df, samples_us_inf)
rbp_us_res <- makeMSNSet(rbp_peptides_us_df, samples_us_inf)
```
Let's check the relative quantification across the labels

```{r}
p <- plotLabelQuant(total_ni_res, log=T)
p <- plotLabelQuant(rbp_ni_res, log=T)
p <- plotLabelQuant(total_us_res, log=T)
p <- plotLabelQuant(rbp_us_res, log=T)
```
For the Total N_I experiment, 4hr-Starved_1 seems to be sticking out. For the Total & RBP U_S experiment, 4hr-Starved_4 seems to be sticking out. 

```{r, echo=F, eval=F}
# Remove all values below 99th percentile of empty tag ("126") and all values for the empty tag
filterLowIntensity <- function(res){
  empty_tag_values <- exprs(res)[,"126"]
  empty_tag_values <- empty_tag_values[is.finite(empty_tag_values)]
  threshold <- quantile(empty_tag_values, 0.99)
  print(threshold)
  exprs(res)[exprs(res)<threshold]<-NA
  res <- res[,2:10] # remove the Empty tag entirely!
  invisible(res)
}
```

```{r, echo=F, eval=F}
total_res <- filterLowIntensity(total_res)
rbp_res <- filterLowIntensity(rbp_res)

p <- plotLabelQuant(total_res, log=T)
p <- plotLabelQuant(rbp_res, log=T)
```

Aggregate over the peptides with the same sequence but different modifications. Don't worry about the errors. Missing values are correctly handled here.
```{r}

total_ni_res_pep_agg <- agg_to_peptides(total_ni_res)
rbp_ni_res_pep_agg <- agg_to_peptides(rbp_ni_res)

total_us_res_pep_agg <- agg_to_peptides(total_us_res)
rbp_us_res_pep_agg <- agg_to_peptides(rbp_us_res)

saveRDS(total_ni_res_pep_agg, file="../results/total_ni_res_pep_agg.rds")
saveRDS(rbp_ni_res_pep_agg, file="../results/rbp_ni_res_pep_agg.rds")
saveRDS(total_us_res_pep_agg, file="../results/total_us_res_pep_agg.rds")
saveRDS(rbp_us_res_pep_agg, file="../results/rbp_us_res_pep_agg.rds")

```

Re-check missing values
```{r}
summariseMissing(total_ni_res_pep_agg)
summariseMissing(rbp_ni_res_pep_agg)
summariseMissing(total_us_res_pep_agg)
summariseMissing(rbp_us_res_pep_agg)
```
OK, so very few missing values now. This is what we would expect. Now, we aggregate from peptide-level to protein level abundance

```{r}
total_ni_res_pro_agg <- agg_to_protein(total_ni_res_pep_agg, "Master.Protein.Accessions")
rbp_ni_res_pro_agg <- agg_to_protein(rbp_ni_res_pep_agg, "Master.Protein.Accessions")

total_us_res_pro_agg <- agg_to_protein(total_us_res_pep_agg, "Master.Protein.Accessions")
rbp_us_res_pro_agg <- agg_to_protein(rbp_us_res_pep_agg, "Master.Protein.Accessions")

saveRDS(total_ni_res_pro_agg, file="../results/total_ni_res_pro_agg.rds")
saveRDS(rbp_ni_res_pro_agg, file="../results/rbp_ni_res_pro_agg.rds")
saveRDS(total_us_res_pro_agg, file="../results/total_us_res_pro_agg.rds")
saveRDS(rbp_us_res_pro_agg, file="../results/rbp_us_res_pro_agg.rds")
```

And summarise the missing values again. 
```{r}
summariseMissing(total_ni_res_pro_agg)
summariseMissing(rbp_ni_res_pro_agg)
summariseMissing(total_us_res_pro_agg)
summariseMissing(rbp_us_res_pro_agg)
```
Note, we're now down to very few missing values. So few that I'd recommend we simply remove these proteins entirely (0/2792 Total NI proteins; 1/1399 RBP NI proteins; 3/2805 for Total US proteins, 33/1048). Since the maximal missing values is 3%, we will remove proteins with missing values for now. Only exception might be RBP U_S in case we are loosing important ones. 
```{r}
total_ni_res_pro_agg <- total_ni_res_pro_agg[rowSums(is.na(exprs(total_ni_res_pro_agg)))==0,]
rbp_ni_res_pro_agg <- rbp_ni_res_pro_agg[rowSums(is.na(exprs(rbp_ni_res_pro_agg)))==0,]
total_us_res_pro_agg <- total_us_res_pro_agg[rowSums(is.na(exprs(total_us_res_pro_agg)))==0,]
rbp_us_res_pro_agg <- rbp_us_res_pro_agg[rowSums(is.na(exprs(rbp_us_res_pro_agg)))==0,]

summariseMissing(total_ni_res_pro_agg)
summariseMissing(rbp_ni_res_pro_agg)
summariseMissing(total_us_res_pro_agg)
summariseMissing(rbp_us_res_pro_agg)
```

Below, we check how many peptides we have per protein.
```{r}

plotPepCounts <- function(res_pep_agg){
fData(res_pep_agg) <- fData(res_pep_agg)[,-grep("CV.*", colnames(fData(res_pep_agg)))]

gb <- fData(res_pep_agg)$Master.Protein.Accessions
gb <- factor(gb, levels = unique(gb))
peptide_counts <- as.data.frame(table(gb))

print(sprintf("Out of %s master proteins, we have %s one-hit wonder proteins (%s %%)",
              length(unique(gb)), sum(peptide_counts==1),
              round(100*sum(peptide_counts==1)/length(unique(gb)), 1)))

p <- ggplot(peptide_counts, aes(log(Freq,2))) + geom_histogram() + my_theme
return(p)
}

p1=plotPepCounts(total_ni_res_pep_agg)
p2=plotPepCounts(rbp_ni_res_pep_agg)
p3=plotPepCounts(total_us_res_pep_agg)
p4=plotPepCounts(rbp_us_res_pep_agg)

grid.arrange(p1,p2,p3,p4,nrow=2)
```
So we have 13-19% "one-hit" wonders across the 4 experiments (NI - Total,RBP; US - Total,RBP). We'll leave these in for now but we could consider excluding these as we have less confident abundance estimates here

Next, we log center normalise the data. The total amount of peptide labelled in each sample should be the same so we can assume any difference in the total intensity per tag is due to inaccuracies in peptide quantification prior to labelling, pipetting etc, or non-identical labelling efficiencies. Whatever the cause, we can normalise the tags since we want to obtain a relative measure between tags. The plots below show before and after normalisation
```{r}
total_ni_res_pro_agg_norm <- logCenterNormalise(total_ni_res_pro_agg)
exprs(total_ni_res_pro_agg_norm) <- exprs(total_ni_res_pro_agg_norm) + median(log2(exprs(total_ni_res_pro_agg)))
  
rbp_ni_res_pro_agg_norm <- logCenterNormalise(rbp_ni_res_pro_agg)
exprs(rbp_ni_res_pro_agg_norm) <- exprs(rbp_ni_res_pro_agg_norm) + median(log2(exprs(rbp_ni_res_pro_agg)))

total_us_res_pro_agg_norm <- logCenterNormalise(total_us_res_pro_agg)
exprs(total_us_res_pro_agg_norm) <- exprs(total_us_res_pro_agg_norm) + median(log2(exprs(total_us_res_pro_agg)))
  
rbp_us_res_pro_agg_norm <- logCenterNormalise(rbp_us_res_pro_agg)
exprs(rbp_us_res_pro_agg_norm) <- exprs(rbp_us_res_pro_agg_norm) + median(log2(exprs(rbp_us_res_pro_agg)))
```


```{r}
pa <- plotLabelQuant(total_ni_res_pro_agg, log=TRUE)
pb <- plotLabelQuant(rbp_ni_res_pro_agg, log=TRUE)

pc <- plotLabelQuant(total_ni_res_pro_agg_norm, log=FALSE)
pd <- plotLabelQuant(rbp_ni_res_pro_agg_norm, log=FALSE)

pe <- plotLabelQuant(total_us_res_pro_agg, log=TRUE)
pf <- plotLabelQuant(rbp_us_res_pro_agg, log=TRUE)

pg <- plotLabelQuant(total_us_res_pro_agg_norm, log=FALSE)
ph <- plotLabelQuant(rbp_us_res_pro_agg_norm, log=FALSE)

grid.arrange(pa$p2,pb$p2,pc$p2,pd$p2,pe$p2,pf$p2,pg$p2,ph$p2,nrow=4)
```
```

```{r}
saveRDS(total_ni_res_pro_agg_norm, file="../results/total_ni_res_pro_agg_norm")
saveRDS(rbp_ni_res_pro_agg_norm, file="../results/rbp_ni_res_pro_agg_norm")
saveRDS(total_us_res_pro_agg_norm, file="../results/total_us_res_pro_agg_norm")
saveRDS(rbp_us_res_pro_agg_norm, file="../results/rbp_us_res_pro_agg_norm")
```


